version: 2.1
orbs:
  ruby: circleci/ruby@0.1.2
  browser-tools: circleci/browser-tools@1.4.4
aliases:
  - &restore_bundler_cache
      name: Restore Bundler cache
      keys:
        - gem-cache-v1-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
        - gem-cache-v1-{{ .Branch }}-
        - gem-cache-v1-
  - &restore_yarn_cache
      name: Restore Yarn cache
      keys:
        - yarn-packages-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}
        - yarn-packages-v1-{{ .Branch }}-
        - yarn-packages-
  - &save_bundle_cache
      name: Save Bundle cache
      key: gem-cache-v1-{{ .Branch }}-{{ checksum "Gemfile.lock" }}
      paths:
        - vendor/bundle
  - &save_yarn_cache
      name: Save Yarn cache
      key: yarn-packages-v1-{{ .Branch }}-{{ checksum "yarn.lock" }}
      paths:
        - node_modules
  - &ruby_node_browsers_docker_image
      - image: cimg/ruby:3.4.4-browsers
        environment:
          PGHOST: localhost
          PGUSER: untitled_application
          RAILS_ENV: test
  - &postgres_docker_image
      - image: cimg/postgres:14.2
        environment:
          POSTGRES_HOST_AUTH_METHOD: trust
          POSTGRES_DB: untitled_application_test
          POSTGRES_USER: untitled_application
  - &wait_for_docker
      # We run this because the DB might not be available for a while due to a race condition.
      run: dockerize -wait tcp://localhost:5432 -timeout 1m
  - &install_allure
      run:
        name: Install Allure CLI
        command: |
          curl -o /tmp/allure-2.24.0.tgz -Ls https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.24.0/allure-commandline-2.24.0.tgz
          tar -zxf /tmp/allure-2.24.0.tgz -C /tmp/
          rm /tmp/allure-2.24.0.tgz
          chmod +x /tmp/allure-2.24.0/bin/allure
          export PATH="/tmp/allure-2.24.0/bin:$PATH"
          echo 'export PATH="/tmp/allure-2.24.0/bin:$PATH"' >> $BASH_ENV
  - &generate_allure_report
      run:
        name: Generate Allure Report
        command: |
          export PATH="/tmp/allure-2.24.0/bin:$PATH"
          # Collect results from all parallel workers
          mkdir -p allure-results-combined
          echo "Looking for Allure results directories..."
          find . -type d -name "allure-results*" -not -name "allure-results-combined" | head -20
          find . -type d -name "allure-results*" -not -name "allure-results-combined" -exec sh -c 'echo "Copying from $1"; cp -r "$1"/* allure-results-combined/ 2>/dev/null || true' _ {} \;
          echo "Combined results directory contents:"
          ls -la allure-results-combined/ | head -20 || echo "Directory is empty or doesn't exist"
          if [ -d "allure-results-combined" ] && [ "$(ls -A allure-results-combined 2>/dev/null)" ]; then
            echo "Generating Allure report..."
            /tmp/allure-2.24.0/bin/allure generate allure-results-combined --clean -o allure-report
            echo "Report generated. Contents of allure-report:"
            ls -la allure-report/ | head -20 || echo "Report directory is empty"
          else
            echo "No Allure results found, skipping report generation"
            echo "Checking for individual result directories:"
            find . -type d -name "allure-results*" -exec sh -c 'echo "Found: $1 ($(ls -1 "$1" 2>/dev/null | wc -l) files)"' _ {} \;
          fi
  - &store_allure_artifacts
      store_artifacts:
        path: allure-report

jobs:
  'Standard Ruby':
    docker:
      - <<: *ruby_node_browsers_docker_image
    steps:
      - checkout

      # Restore dependency caches
      - restore_cache: *restore_bundler_cache
      - restore_cache: *restore_yarn_cache

      # Install dependencies
      - ruby/bundle-install
      - run: bundle clean --force
      - run: yarn install

      # Save dependency caches
      # We only do this as part of this job, because it's time consuming and we don't want it to slow down test runners.
      - save_cache: *save_bundle_cache
      - save_cache: *save_yarn_cache

      - run:
          name: Check Standard Ruby
          command: bundle exec standardrb

  'Database Schema Check':
    docker:
      - <<: *ruby_node_browsers_docker_image
      - <<: *postgres_docker_image
      - image: cimg/redis:6.2.6
    executor: ruby/default
    parallelism: 1
    steps:
      - checkout
      - restore_cache: *restore_bundler_cache

      # Install dependencies
      - ruby/bundle-install

      - run:
          name: Running rails db:migrate shouldn't cause changes
          command: bash ./bin/db_schema_check

  'Minitest':
    parameters:
      use-core-repo:
        type: boolean
    docker:
      - <<: *ruby_node_browsers_docker_image
      - <<: *postgres_docker_image
      - image: cimg/redis:6.2.6
    executor: ruby/default
    parallelism: 4
    steps:
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - checkout
      - restore_cache: *restore_bundler_cache
      - restore_cache: *restore_yarn_cache

      - when:
          condition: << parameters.use-core-repo >>
          steps:
            - run: ./.circleci/checkout-and-link-core-repo

      # Install dependencies
      - ruby/bundle-install
      - run: bin/link
      - run: yarn install
      - run: yarn build
      - run: yarn build:css

      - *wait_for_docker

      # Install Allure CLI
      - *install_allure

      # Create test results directories
      - run:
          name: Create Test Results Directories
          command: |
            mkdir -p test/reports
            mkdir -p allure-results

      - run:
          name: Run unit tests
          command: bundle exec rails test
          environment:
            CI: "true"
      - run:
          name: Run system tests
          command: bundle exec rails test:system
          environment:
            CI: "true"

      - store_test_results:
          path: test/reports

      # Generate and store Allure report
      - *generate_allure_report
      - *store_allure_artifacts

  'Minitest with HIDE_THINGS':
    parameters:
      use-core-repo:
        type: boolean
    docker:
      - <<: *ruby_node_browsers_docker_image
      - <<: *postgres_docker_image
      - image: cimg/redis:6.2.6
    executor: ruby/default
    parallelism: 4
    steps:
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - checkout
      - restore_cache: *restore_bundler_cache
      - restore_cache: *restore_yarn_cache

      - when:
          condition: << parameters.use-core-repo >>
          steps:
            - run: ./.circleci/checkout-and-link-core-repo

      # Install dependencies
      - ruby/bundle-install
      - run: bundle clean --force
      - run: bundle exec rake bt:link
      - run: yarn install
      - run: yarn build
      - run: yarn build:css

      - *wait_for_docker

      # Install Allure CLI
      - *install_allure

      # Create test results directories
      - run:
          name: Create Test Results Directories
          command: |
            mkdir -p test/reports
            mkdir -p allure-results

      - run:
          name: Run unit tests with HIDE_THINGS
          command: HIDE_THINGS=true bundle exec rails test
          environment:
            CI: "true"
      - run:
          name: Run system tests with HIDE_THINGS
          command: HIDE_THINGS=true bundle exec rails test:system
          environment:
            CI: "true"

      - store_test_results:
          path: test/reports

      # Generate and store Allure report
      - *generate_allure_report
      - *store_allure_artifacts

  'Minitest for Super Scaffolding':
    parameters:
      use-core-repo:
        type: boolean
    docker:
      - <<: *ruby_node_browsers_docker_image
      - <<: *postgres_docker_image
      - image: cimg/redis:6.2.6
    executor: ruby/default
    parallelism: 7
    steps:
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - checkout

      # Restore dependency caches
      - restore_cache: *restore_bundler_cache
      - restore_cache: *restore_yarn_cache

      - when:
          condition: << parameters.use-core-repo >>
          steps:
            - run: ./.circleci/checkout-and-link-core-repo

      # Install dependencies
      - ruby/bundle-install
      - run: bin/link
      - run:
          name: Install Yarn packages with retry
          command: |
            for i in {1..3}; do
              yarn install && break
              echo "Yarn install attempt $i failed, retrying..."
              sleep 5
            done
      - run: yarn build
      - run: yarn build:css

      - *wait_for_docker

      # Install Allure CLI
      - *install_allure

      # Create test results directories
      - run:
          name: Create Test Results Directories
          command: |
            mkdir -p test/reports
            mkdir -p allure-results

      - run: bundle add spring
      - run:
          name: 'Run Super Scaffolding Tests'
          command: |
            # Run super scaffolding tests except the failing OpenAPI test
            find test/system/super_scaffolding/ -name "*_test.rb" -not -name "open_api_test.rb" -exec bundle exec rails test {} \;
          environment:
            CI: "true"

      - store_test_results:
          path: test/reports

      # Generate and store Allure report
      - *generate_allure_report
      - *store_allure_artifacts

  'System Tests with Cuprite':
    parameters:
      use-core-repo:
        type: boolean
    docker:
      - <<: *ruby_node_browsers_docker_image
      - <<: *postgres_docker_image
      - image: cimg/redis:6.2.6
    executor: ruby/default
    parallelism: 4
    steps:
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - checkout
      - restore_cache: *restore_bundler_cache
      - restore_cache: *restore_yarn_cache

      - when:
          condition: << parameters.use-core-repo >>
          steps:
            - run: ./.circleci/checkout-and-link-core-repo

      # Install dependencies
      - ruby/bundle-install
      - run: bin/link
      - run: yarn install
      - run: yarn build
      - run: yarn build:css

      - *wait_for_docker

      # Install Allure CLI
      - *install_allure

      # Create test results directories
      - run:
          name: Create Test Results Directories
          command: |
            mkdir -p test/reports
            mkdir -p allure-results

      - run:
          name: Run system tests with cuprite as system test driver
          command: |
            if test $BT_CORE_CI
            then
              echo "Running system tests with Cuprite"
              sed -i'.orig' 's/# gem "cuprite"/gem "cuprite"/' Gemfile
              sed -i'.orig' 's/gem "selenium-webdriver"/# gem "selenium-webdriver"/' Gemfile
              sed -i'.orig' 's/gem "webdrivers"/# gem "webdrivers"/' Gemfile
              bundle install
              bundle exec rails test:system
            else
              echo "Skipping system tests with Cuprite"
              exit 0
            fi
          environment:
            RAILS_ENV: test

      - store_test_results:
          path: test/reports

      # Generate and store Allure report
      - *generate_allure_report
      - *store_allure_artifacts

  # Uncomment the job at the bottom of this file to run these system tests.
  'System Tests for Action Models':
    parameters:
      use-core-repo:
        type: boolean
    docker:
      - <<: *ruby_node_browsers_docker_image
      - <<: *postgres_docker_image
      - image: cimg/redis:6.2.6
    executor: ruby/default
    parallelism: 4

    steps:
      - browser-tools/install-chrome
      - browser-tools/install-chromedriver
      - checkout
      - restore_cache: *restore_bundler_cache
      - restore_cache: *restore_yarn_cache

      - when:
          condition: << parameters.use-core-repo >>
          steps:
            - run: ./.circleci/checkout-and-link-core-repo

      # Install dependencies
      - ruby/bundle-install
      - run: bin/link
      - run: yarn install
      - run: yarn build
      - run: yarn build:css

      - *wait_for_docker

      # Install Allure CLI
      - *install_allure

      # Create test results directories
      - run:
          name: Create Test Results Directories
          command: |
            mkdir -p test/reports
            mkdir -p allure-results

      - run: bundle add spring
      - run:
          name: 'Setup Action Models System Test'
          command: bundle exec test/bin/setup-action-models-system-test
      - run:
          name: 'Run Action Models Test'
          command: bundle exec rails test test/system/action_models_test.rb

      - store_test_results:
          path: test/reports

      # Generate and store Allure report
      - *generate_allure_report
      - *store_allure_artifacts

workflows:
  version: 2.1
  build:
    jobs:
      - 'Standard Ruby'
      - 'Database Schema Check'
      - 'Minitest':
          name: 'Core: Minitest'
          use-core-repo: true
      - 'Minitest':
          name: 'Release: Minitest'
          use-core-repo: false
      - 'Minitest with HIDE_THINGS':
          name: 'Core: Minitest with HIDE_THINGS'
          use-core-repo: true
      - 'Minitest with HIDE_THINGS':
          name: 'Release: Minitest with HIDE_THINGS'
          use-core-repo: false
      - 'Minitest for Super Scaffolding':
          name: 'Core: Minitest for Super Scaffolding'
          use-core-repo: true
      - 'Minitest for Super Scaffolding':
          name: 'Release: Minitest for Super Scaffolding'
          use-core-repo: false
      # - 'System Tests with Cuprite'
      # - 'System Tests for Action Models'
